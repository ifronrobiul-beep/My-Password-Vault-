<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-bg: #0d0c22;
            --secondary-bg: #1a1a3a;
            --accent-color1: #00f6ff;
            --accent-color2: #ff00ea;
            --text-color: #e0e0e0;
            --border-color: rgba(0, 246, 255, 0.3);
            --secondary-btn-bg: #3a3a5a;
            --success-color: #2ecc71;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .hidden { display: none !important; }

        .app-container { width: 100%; max-width: 900px; min-height: 80vh; background: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 16px; padding: 2rem; position: relative; }
        .btn-generic { padding: 0 1.5rem; border-radius: 8px; cursor: pointer; height: 44px; font-weight: 600; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; transition: background-color 0.2s; }
        .btn-secondary { background: var(--secondary-btn-bg); color: var(--text-color); }
        .btn-secondary:hover { background: #4a4a6a; }
        .btn-secondary:disabled { background: #2a2a4a; color: #666; cursor: not-allowed; }
        
        .auth-container, .tool-dashboard-container { width: 100%; max-width: 450px; background: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: 16px; padding: 2.5rem; box-shadow: 0 0 25px rgba(0, 246, 255, 0.1), 0 0 50px rgba(255, 0, 234, 0.1); }
        .tool-dashboard-container { max-width: 700px; }
        .auth-container h1, .tool-dashboard-container h1 { text-align: center; font-weight: 600; font-size: 2rem; margin-bottom: 0.5rem; background: linear-gradient(90deg, var(--accent-color1), var(--accent-color2)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .auth-container p, .tool-dashboard-container p { text-align: center; color: #a0a0a0; margin-bottom: 2rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group select { width: 100%; padding: 12px 15px; background: var(--primary-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); font-size: 1rem; }
        .btn-submit { width: 100%; padding: 14px; border: none; border-radius: 8px; background: linear-gradient(90deg, var(--accent-color1), var(--accent-color2)); color: var(--primary-bg); font-size: 1.1rem; font-weight: 600; cursor: pointer; }
        .auth-link { display: block; text-align: center; margin-top: 1.5rem; color: var(--accent-color1); text-decoration: none; cursor: pointer; }
        .error-message { color: var(--accent-color2); text-align: center; margin-top: 1rem; display: none; }
        .tool-card { background-color: var(--primary-bg); border: 1px solid var(--border-color); transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .tool-card:hover { transform: translateY(-8px); box-shadow: 0 10px 25px rgba(0, 246, 255, 0.2); }
        .back-to-dashboard-btn { background: var(--primary-bg); color: var(--text-color); padding: 8px 16px; border-radius: 8px; cursor: pointer; border: 1px solid var(--border-color); font-weight: 500; position: absolute; top: 1.5rem; left: 2rem; z-index: 50; }
        
        #vaultApp h1 { color: var(--text-color); text-align: center; margin-bottom: 1rem; }
        #vaultApp .controls { display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.5rem; }
        #vaultApp .search-input { flex-grow: 1; min-width: 200px; height: 44px; padding: 12px 15px; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--primary-bg); color: var(--text-color); font-size: 1rem; }
        #vaultApp .btn-add { background: var(--accent-color1); color: var(--primary-bg); }
        #vaultApp .password-list { list-style: none; padding: 0; max-height: 50vh; overflow-y: auto; }
        #vaultApp .password-item { background: var(--primary-bg); border-left: 3px solid var(--accent-color1); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; }
        #vaultApp .actions button { background: none; border: 1px solid var(--border-color); color: var(--text-color); width: 36px; height: 36px; border-radius: 50%; cursor: pointer; }
        #vaultApp .logout-btn { position: absolute; top: 1.5rem; right: 2rem; background: none; border: none; color: #a0a0a0; font-size: 1.5rem; cursor: pointer; }
        #vaultApp .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        #vaultApp .modal-content { background: var(--secondary-bg); padding: 2rem; border-radius: 16px; border: 1px solid var(--border-color); width: 90%; max-width: 500px; position: relative; }
        #vaultApp .modal .close-btn { position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: #a0a0a0; font-size: 1.5rem; cursor: pointer; }
        #vaultApp .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 1.5rem; }
        #vaultApp .insight-card { background: var(--primary-bg); border: 1px solid var(--border-color); border-radius: 12px; padding: 1rem; }
        #vaultApp .insight-label { font-size: 0.9rem; color: #a0a0a0; margin-bottom: 0.35rem; }
        #vaultApp .insight-value { font-size: 1.5rem; font-weight: 600; }
        #vaultApp .chip { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.25rem 0.6rem; border-radius: 999px; font-size: 0.75rem; background: rgba(0, 246, 255, 0.12); color: var(--accent-color1); border: 1px solid rgba(0, 246, 255, 0.2); }
        #vaultApp .health-bar { height: 8px; width: 100%; border-radius: 999px; background: #2b2b4a; overflow: hidden; }
        #vaultApp .health-fill { height: 100%; width: 0%; transition: width 0.3s ease; }
        #vaultApp .activity-list { list-style: none; padding: 0; margin-top: 0.75rem; }
        #vaultApp .activity-item { display: flex; justify-content: space-between; font-size: 0.85rem; color: #c0c0c0; padding: 0.4rem 0; border-bottom: 1px dashed rgba(255,255,255,0.08); }
        #vaultApp .strength-meter { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; }
        #vaultApp .strength-bar { flex: 1; height: 8px; border-radius: 999px; background: #2b2b4a; overflow: hidden; }
        #vaultApp .strength-fill { height: 100%; width: 0%; transition: width 0.3s ease; }
        #vaultApp .generator-controls { background: rgba(0, 246, 255, 0.06); border: 1px solid rgba(0, 246, 255, 0.15); border-radius: 12px; padding: 0.75rem; margin-top: 1rem; }
        #vaultApp .toggle { display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; color: #c0c0c0; }
        #vaultApp .range-input { width: 100%; }
        
        #discordApp { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body>

    <div id="authContainer">
        <div id="loginScreen" class="auth-container hidden">
            <h1>Dashboard Login</h1><p>Securely access your tools.</p>
            <form id="loginForm"><div class="form-group"><label for="loginUsername">Username</label><input type="text" id="loginUsername" required></div><div class="form-group"><label for="loginPassword">Password</label><input type="password" id="loginPassword" required></div><button type="submit" class="btn-submit">Unlock</button><p id="loginError" class="error-message">Invalid username or password.</p></form>
            <a id="forgotPasswordLink" class="auth-link">Forgot your password?</a>
        </div>
        <div id="setupScreen" class="auth-container hidden">
            <h1>First-Time Setup</h1><p>Create your secure account to get started.</p>
            <form id="setupForm"><div class="form-group"><label for="setupUsername">Choose a Username</label><input type="text" id="setupUsername" required></div><div class="form-group"><label for="setupPassword">Create a Strong Password</label><input type="password" id="setupPassword" required></div><hr style="border-color: var(--border-color); margin: 2rem 0;"><p style="margin-bottom: 1rem;">Set up your recovery questions</p><div class="form-group"><label for="q1">Security Question 1</label><select id="q1" required></select><input type="text" id="a1" placeholder="Your Answer (case-sensitive)" required style="margin-top: 0.5rem;"></div><div class="form-group"><label for="q2">Security Question 2</label><select id="q2" required></select><input type="text" id="a2" placeholder="Your Answer (case-sensitive)" required style="margin-top: 0.5rem;"></div><button type="submit" class="btn-submit">Create Account</button></form>
        </div>
        <div id="recoveryScreen" class="auth-container hidden">
            <h1>Password Recovery</h1><p>Answer your security questions to reset your password.</p>
            <form id="recoveryForm"><div class="form-group"><p id="recoveryQ1" style="font-style: italic; color: #a0a0a0;"></p><input type="text" id="recoveryA1" placeholder="Your Answer" required></div><div class="form-group"><p id="recoveryQ2" style="font-style: italic; color: #a0a0a0;"></p><input type="text" id="recoveryA2" placeholder="Your Answer" required></div><button type="submit" class="btn-submit">Verify Answers</button><p id="recoveryError" class="error-message">One or more answers are incorrect.</p></form>
            <a id="backToLoginLink" class="auth-link">Back to Login</a>
        </div>
    </div>
    
    <div id="toolDashboard" class="tool-dashboard-container hidden">
        <button id="mainLogoutBtn" class="logout-btn" title="Lock Dashboard" style="position:absolute; top: 1.5rem; right: 2rem; font-size:1.5rem; color: #a0a0a0; background: none; border: none; cursor: pointer;"><i class="fas fa-sign-out-alt"></i></button>
        <h1>Tool Dashboard</h1><p>Choose a tool to get started.</p>
        <div class="flex flex-col md:flex-row gap-8 mt-8">
            <div id="selectVault" class="tool-card w-full p-8 rounded-2xl cursor-pointer text-center"><i class="fas fa-shield-halved fa-3x mb-4 text-sky-400"></i><h2 class="text-2xl font-bold mb-2">Cyber Vault</h2><p class="text-gray-400">Manage your passwords.</p></div>
            <div id="selectDiscord" class="tool-card w-full p-8 rounded-2xl cursor-pointer text-center"><i class="fab fa-discord fa-3x mb-4 text-indigo-400"></i><h2 class="text-2xl font-bold mb-2">Discord Sender</h2><p class="text-gray-400">Send webhook messages.</p></div>
        </div>
    </div>

    <div id="vaultApp" class="app-container hidden">
        <button class="back-to-dashboard-btn"><i class="fas fa-arrow-left mr-2"></i>Dashboard</button>
        <button id="vaultLogoutBtn" class="logout-btn" title="Lock Dashboard"><i class="fas fa-sign-out-alt"></i></button>
        <h1>My Password Vault</h1>
        <div class="controls"><input type="text" id="searchInput" class="search-input" placeholder="Search entries..."><button id="addPasswordBtn" class="btn-generic btn-add">Add New</button></div>
        <hr style="border-color: var(--border-color); margin: 1.5rem 0;">
        <div class="controls">
            <span id="driveStatus" style="display:flex; align-items:center; gap: 0.5rem; color: #a0a0a0;">Initializing...</span>
            <button id="driveAuthBtn" class="btn-generic btn-secondary" disabled><i class="fab fa-google-drive"></i><span>Connect to Drive</span></button>
            <button id="driveBackupBtn" class="btn-generic btn-secondary" disabled><i class="fas fa-upload"></i>Backup to Drive</button>
            <button id="driveRestoreBtn" class="btn-generic btn-secondary" disabled><i class="fas fa-download"></i>Restore from Drive</button>
        </div>
        <div class="insights-grid">
            <div class="insight-card">
                <div class="insight-label">Vault Entries</div>
                <div id="totalEntries" class="insight-value">0</div>
                <div class="chip"><i class="fas fa-database"></i><span>Encrypted locally</span></div>
            </div>
            <div class="insight-card">
                <div class="insight-label">Password Health</div>
                <div id="healthScore" class="insight-value">0%</div>
                <div class="health-bar"><div id="healthFill" class="health-fill" style="background: var(--accent-color1);"></div></div>
                <div class="insight-label" style="margin-top: 0.5rem;">Weak / Reused</div>
                <div id="riskSummary" class="chip"><i class="fas fa-shield-exclamation"></i><span>0 / 0</span></div>
            </div>
            <div class="insight-card">
                <div class="insight-label">Security Highlights</div>
                <div class="chip" style="margin-bottom: 0.5rem;"><i class="fas fa-fingerprint"></i><span>Recovery Ready</span></div>
                <div class="chip"><i class="fas fa-cloud-arrow-up"></i><span>Drive Backup</span></div>
                <ul id="activityList" class="activity-list"></ul>
            </div>
        </div>
        <ul id="passwordList" class="password-list"></ul>
        <div id="passwordModal" class="modal hidden"><div class="modal-content"><button class="close-btn">&times;</button><h2 id="modalTitle" style="text-align:center; margin-bottom: 1.5rem;">Add New Entry</h2><form id="passwordForm"><input type="hidden" id="passwordId"><div class="form-group"><label for="websiteName">Website Name</label><input type="text" id="websiteName" required></div><div class="form-group"><label for="entryUsername">Username / Email</label><input type="text" id="entryUsername" required></div><div class="form-group"><label for="entryPassword">Password</label><input type="password" id="entryPassword" required><div class="strength-meter"><div class="strength-bar"><div id="strengthFill" class="strength-fill"></div></div><span id="strengthLabel" style="font-size:0.85rem; color:#a0a0a0;">Strength</span></div></div><div class="generator-controls"><div class="form-group"><label for="passwordLength">Password Length: <span id="lengthValue">16</span></label><input type="range" id="passwordLength" class="range-input" min="8" max="32" value="16"></div><div style="display:flex; flex-wrap:wrap; gap:0.75rem; margin-bottom:0.75rem;"><label class="toggle"><input type="checkbox" id="includeSymbols" checked> Include symbols</label><label class="toggle"><input type="checkbox" id="includeNumbers" checked> Include numbers</label><label class="toggle"><input type="checkbox" id="includeUppercase" checked> Include uppercase</label></div><button type="button" id="generatePasswordBtn" class="btn-generic btn-secondary" style="width:100%;"><i class="fas fa-wand-magic-sparkles"></i>Generate Strong Password</button></div><button type="submit" class="btn-submit">Save Entry</button></form></div></div>
    </div>
    
    <div id="discordApp" class="hidden">
        <div class="min-h-screen w-full flex items-center justify-center p-4">
             <button class="back-to-dashboard-btn"><i class="fas fa-arrow-left mr-2"></i>Dashboard</button>
            <div class="w-full max-w-4xl bg-gray-800 rounded-2xl shadow-2xl overflow-hidden border border-slate-700">
                <header class="p-6 bg-slate-900/70 border-b border-slate-700"><div class="flex items-center space-x-4"><div class="p-3 bg-blue-500 rounded-lg"><i class="fab fa-discord fa-2x text-white"></i></div><div><h1 class="text-2xl font-bold text-white">Discord Webhook Dashboard</h1><p class="text-slate-400 text-sm">Send messages to your Discord server instantly.</p></div></div></header>
                <main class="p-6 md:p-8 grid md:grid-cols-2 gap-8">
                    <div class="flex flex-col space-y-6">
                        <div><label for="webhookUrl" class="block text-sm font-medium text-slate-300 mb-2">Webhook URL</label><div class="relative"><i class="fas fa-link absolute top-1/2 left-3 -translate-y-1/2 text-slate-500"></i><input type="url" id="webhookUrl" class="w-full pl-10 pr-4 py-2 rounded-lg" placeholder="https://discord.com/api/webhooks/..." style="background-color: #1e293b; border: 1px solid #334155;"></div></div>
                        <div><label for="messageContent" class="block text-sm font-medium text-slate-300 mb-2">Message Content</label><textarea id="messageContent" rows="8" class="w-full p-3 rounded-lg" placeholder="Enter your message here..." style="background-color: #1e293b; border: 1px solid #334155;"></textarea></div>
                    </div>
                    <div class="flex flex-col space-y-6">
                        <div class="bg-slate-900/50 p-4 rounded-lg border border-slate-700">
                            <h3 class="font-semibold text-white mb-3">Bot Appearance (Optional)</h3>
                            <div class="space-y-4">
                                <div><label for="username" class="block text-sm font-medium text-slate-300 mb-2">Username</label><div class="relative"><i class="fas fa-user-circle absolute top-1/2 left-3 -translate-y-1/2 text-slate-500"></i><input type="text" id="username" class="w-full pl-10 pr-4 py-2 rounded-lg" placeholder="Custom Bot Name" style="background-color: #1e293b; border: 1px solid #334155;"></div></div>
                                <div><label for="avatarUrl" class="block text-sm font-medium text-slate-300 mb-2">Avatar URL</label><div class="relative"><i class="fas fa-image absolute top-1/2 left-3 -translate-y-1/2 text-slate-500"></i><input type="url" id="avatarUrl" class="w-full pl-10 pr-4 py-2 rounded-lg" placeholder="https://i.imgur.com/..." style="background-color: #1e293b; border: 1px solid #334155;"></div></div>
                            </div>
                        </div>
                        <div class="flex-grow flex flex-col justify-end space-y-4">
                            <div id="statusMessage" class="p-4 rounded-lg text-sm text-center hidden"></div>
                            <button id="sendMessageBtn" class="w-full font-bold py-3 rounded-lg flex items-center justify-center space-x-2" style="background-color:#5865F2; color:white;"><i class="fas fa-paper-plane"></i><span>Send Message</span><div id="spinner" class="animate-spin rounded-full h-5 w-5 border-b-2 border-white hidden"></div></button>
                            <button id="clearFormBtn" class="w-full font-medium py-2 rounded-lg" style="background-color:#4f545c; color:white;"><i class="fas fa-times"></i> Clear Form</button>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIGURATION ---
    const GOOGLE_CLIENT_ID = 'YOUR_CLIENT_ID_GOES_HERE'; // <-- PASTE YOUR CLIENT ID HERE
    const DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
    
    // --- SCREEN MANAGEMENT & GLOBAL STATE ---
    const screens = { auth: document.getElementById('authContainer'), login: document.getElementById('loginScreen'), setup: document.getElementById('setupScreen'), recovery: document.getElementById('recoveryScreen'), dashboard: document.getElementById('toolDashboard'), vault: document.getElementById('vaultApp'), discord: document.getElementById('discordApp') };
    const showScreen = (screenName) => { Object.values(screens).forEach(s => s.classList.add('hidden')); const screenToShow = screens[screenName]; if (screenToShow) { screenToShow.classList.remove('hidden'); if (['login', 'setup', 'recovery'].includes(screenName)) { screens.auth.classList.remove('hidden'); } } };
    const vaultStorageKey = 'masterDashboardData';
    const activityLogKey = 'masterDashboardActivity';
    let activePassword = '';
    let passwordEntries = [];
    let activityLog = [];
    const securityQuestions = [ "What was the name of your first pet?", "What is your mother's maiden name?", "What was the name of your elementary school?", "In what city were you born?", "What is your favorite movie?", "What was the make of your first car?" ];
    const encrypt = (text, key) => CryptoJS.AES.encrypt(text, key).toString();
    const decrypt = (ciphertext, key) => CryptoJS.AES.decrypt(ciphertext, key).toString(CryptoJS.enc.Utf8);
    const hash = (text) => CryptoJS.SHA256(text).toString();
    
    // --- GOOGLE DRIVE INTEGRATION ---
    let tokenClient;
    const driveAuthBtn = document.getElementById('driveAuthBtn');
    const driveBackupBtn = document.getElementById('driveBackupBtn');
    const driveRestoreBtn = document.getElementById('driveRestoreBtn');
    const driveStatus = document.getElementById('driveStatus');

    function gapiLoaded() { gapi.load('client', initializeGapiClient); }
    async function initializeGapiClient() { await gapi.client.init({ discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] }); }
    function gisLoaded() {
        if (!GOOGLE_CLIENT_ID || GOOGLE_CLIENT_ID === 'YOUR_CLIENT_ID_GOES_HERE') { driveStatus.innerHTML = `<i class="fas fa-exclamation-triangle" style="color: #e74c3c;"></i> Google Client ID is not set.`; return; }
        tokenClient = google.accounts.oauth2.initTokenClient({ client_id: GOOGLE_CLIENT_ID, scope: DRIVE_SCOPES, callback: handleGoogleAuthResponse });
        driveAuthBtn.disabled = false;
        driveStatus.innerHTML = `<i class="fas fa-times-circle" style="color: #e74c3c;"></i> Disconnected`;
    }
    driveAuthBtn.addEventListener('click', () => { if (gapi.client.getToken() === null) { tokenClient.requestAccessToken({prompt: 'consent'}); } else { gapi.client.setToken(null); updateDriveUi(false); } });
    function handleGoogleAuthResponse(resp) { if (resp.error) { console.error(resp); alert('Authentication error.'); return; } updateDriveUi(true); }
    function updateDriveUi(isSignedIn) {
        driveStatus.innerHTML = isSignedIn ? `<i class="fas fa-check-circle" style="color: var(--success-color);"></i> Connected` : `<i class="fas fa-times-circle" style="color: #e74c3c;"></i> Disconnected`;
        driveAuthBtn.querySelector('span').textContent = isSignedIn ? 'Disconnect' : 'Connect to Google Drive';
        driveBackupBtn.disabled = !isSignedIn; driveRestoreBtn.disabled = !isSignedIn;
    }
    async function findBackupFile() { try { const res = await gapi.client.drive.files.list({ q: "name='cyber_vault_backup.json'", spaces: 'appDataFolder', fields: 'files(id)' }); return res.result.files && res.result.files.length > 0 ? res.result.files[0].id : null; } catch (err) { console.error(err); return null; } }
    driveBackupBtn.addEventListener('click', async () => {
        const vaultDataString = localStorage.getItem(vaultStorageKey); if (!vaultDataString) { alert("No data to back up."); return; }
        driveBackupBtn.disabled = true; driveBackupBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Backing up...`;
        const fileId = await findBackupFile();
        const boundary = '-------314159265358979323846';
        const metadata = { 'name': 'cyber_vault_backup.json', 'mimeType': 'application/json' };
        if (!fileId) { metadata.parents = ['appDataFolder']; }
        const multipartRequestBody = `--${boundary}\r\nContent-Type: application/json; charset=UTF-8\r\n\r\n${JSON.stringify(metadata)}\r\n--${boundary}\r\nContent-Type: application/json\r\n\r\n${vaultDataString}\r\n--${boundary}--`;
        try {
            const request = await gapi.client.request({
                'path': `/upload/drive/v3/files${fileId ? `/${fileId}` : ''}`,
                'method': fileId ? 'PATCH' : 'POST', 'params': {'uploadType': 'multipart'},
                'headers': {'Content-Type': `multipart/related; boundary="${boundary}"`}, 'body': multipartRequestBody
            });
            if (request.status === 200) { alert('Backup successful!'); } else { throw new Error(request.body); }
        } catch(err) { alert('Backup failed.'); console.error(err); }
        finally { driveBackupBtn.disabled = false; driveBackupBtn.innerHTML = `<i class="fas fa-upload"></i> Backup to Drive`; }
    });
    driveRestoreBtn.addEventListener('click', async () => {
        if (!confirm("This will overwrite your current vault. Are you sure?")) return;
        driveRestoreBtn.disabled = true; driveRestoreBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Restoring...`;
        const fileId = await findBackupFile();
        if (!fileId) { alert("No backup file found in Google Drive."); }
        else {
            try {
                const response = await gapi.client.drive.files.get({ fileId: fileId, alt: 'media' });
                const importedData = response.body; JSON.parse(importedData);
                localStorage.setItem(vaultStorageKey, importedData);
                alert("Vault restored successfully! Please log out and log back in to load the new data."); handleLogout();
            } catch (err) { alert("Failed to restore backup."); console.error(err); }
        }
        driveRestoreBtn.disabled = false; driveRestoreBtn.innerHTML = `<i class="fas fa-download"></i> Restore from Drive`;
    });

    // --- SETUP, LOGIN, RECOVERY, NAVIGATION, and OTHER APP LOGIC ---
    // This logic is identical to the previous version and is included here for completeness.
    const populateSecurityQuestions = () => { const q1 = document.getElementById('q1'), q2 = document.getElementById('q2'); securityQuestions.forEach(q => { q1.innerHTML += `<option value="${q}">${q}</option>`; q2.innerHTML += `<option value="${q}">${q}</option>`; }); q1.selectedIndex = 0; q2.selectedIndex = 1; };
    document.getElementById('setupForm').addEventListener('submit', (e) => { e.preventDefault(); const u = document.getElementById('setupUsername').value.trim(), p = document.getElementById('setupPassword').value, q1 = document.getElementById('q1').value, a1 = document.getElementById('a1').value.trim(), q2 = document.getElementById('q2').value, a2 = document.getElementById('a2').value.trim(); if (!u || !p || !a1 || !a2 || q1 === q2) return; const d = { username: u, encryptedData: encrypt(JSON.stringify([]), p), security: { q1, q2, answersHash: hash(a1 + a2) } }; localStorage.setItem(vaultStorageKey, JSON.stringify(d)); activePassword = p; showScreen('dashboard'); });
    document.getElementById('loginForm').addEventListener('submit', (e) => { e.preventDefault(); const u = document.getElementById('loginUsername').value.trim(), p = document.getElementById('loginPassword').value, d = JSON.parse(localStorage.getItem(vaultStorageKey)); if (d && d.username.toLowerCase() === u.toLowerCase()) { try { const dec = decrypt(d.encryptedData, p); if (!dec) throw new Error(); activePassword = p; passwordEntries = JSON.parse(dec); activityLog = JSON.parse(localStorage.getItem(activityLogKey) || '[]'); renderPasswords(); updateVaultInsights(); showScreen('dashboard'); document.getElementById('loginError').style.display = 'none'; e.target.reset(); } catch (err) { document.getElementById('loginError').style.display = 'block'; } } else { document.getElementById('loginError').style.display = 'block'; } });
    document.getElementById('forgotPasswordLink').addEventListener('click', () => { const d = JSON.parse(localStorage.getItem(vaultStorageKey)); if (!d) { alert("No account found."); return; } document.getElementById('recoveryQ1').textContent = d.security.q1; document.getElementById('recoveryQ2').textContent = d.security.q2; showScreen('recovery'); });
    document.getElementById('recoveryForm').addEventListener('submit', (e) => { e.preventDefault(); const a1 = document.getElementById('recoveryA1').value.trim(), a2 = document.getElementById('recoveryA2').value.trim(), d = JSON.parse(localStorage.getItem(vaultStorageKey)); if (hash(a1 + a2) === d.security.answersHash) { const nP = prompt("OK! New password (min 6 chars). WARNING: This resets your password but ERASEs saved entries."); if (nP && nP.length >= 6) { d.encryptedData = encrypt(JSON.stringify([]), nP); localStorage.setItem(vaultStorageKey, JSON.stringify(d)); alert("Password reset. Vault is empty. Please log in."); showScreen('login'); } else if (nP !== null) { alert("Password too short."); } } else { document.getElementById('recoveryError').style.display = 'block'; } });
    document.getElementById('backToLoginLink').addEventListener('click', () => showScreen('login'));
    document.getElementById('selectVault').addEventListener('click', () => showScreen('vault'));
    document.getElementById('selectDiscord').addEventListener('click', () => showScreen('discord'));
    document.querySelectorAll('.back-to-dashboard-btn').forEach(btn => btn.addEventListener('click', () => showScreen('dashboard')));
    function handleLogout() { activePassword = ''; passwordEntries = []; activityLog = []; showScreen('login'); }
    document.getElementById('mainLogoutBtn').addEventListener('click', handleLogout); document.getElementById('vaultLogoutBtn').addEventListener('click', handleLogout);
    const pv = { addPasswordBtn: document.getElementById('addPasswordBtn'), passwordModal: document.getElementById('passwordModal'), searchInput: document.getElementById('searchInput'), passwordList: document.getElementById('passwordList'), passwordForm: document.getElementById('passwordForm'), modalTitle: document.getElementById('modalTitle'), passwordIdInput: document.getElementById('passwordId'), strengthFill: document.getElementById('strengthFill'), strengthLabel: document.getElementById('strengthLabel'), passwordLength: document.getElementById('passwordLength'), lengthValue: document.getElementById('lengthValue'), includeSymbols: document.getElementById('includeSymbols'), includeNumbers: document.getElementById('includeNumbers'), includeUppercase: document.getElementById('includeUppercase'), generatePasswordBtn: document.getElementById('generatePasswordBtn') };
    const savePasswordsToStorage = () => { const d = JSON.parse(localStorage.getItem(vaultStorageKey)); d.encryptedData = encrypt(JSON.stringify(passwordEntries), activePassword); localStorage.setItem(vaultStorageKey, JSON.stringify(d)); };
    const logActivity = (message) => { const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); activityLog.unshift({ message, time }); activityLog = activityLog.slice(0, 5); localStorage.setItem(activityLogKey, JSON.stringify(activityLog)); };
    const strengthScore = (password) => { let score = 0; if (password.length >= 12) score += 1; if (/[A-Z]/.test(password)) score += 1; if (/[0-9]/.test(password)) score += 1; if (/[^A-Za-z0-9]/.test(password)) score += 1; if (password.length >= 16) score += 1; return Math.min(score, 4); };
    const strengthLabel = (score) => ['Weak', 'Fair', 'Good', 'Strong', 'Elite'][score] || 'Weak';
    const strengthColor = (score) => ['#e74c3c', '#f39c12', '#f1c40f', '#2ecc71', '#00f6ff'][score] || '#e74c3c';
    const updateStrengthMeter = (password) => { const score = strengthScore(password); const pct = ((score + 1) / 5) * 100; pv.strengthFill.style.width = `${pct}%`; pv.strengthFill.style.background = strengthColor(score); pv.strengthLabel.textContent = strengthLabel(score); };
    const updateVaultInsights = () => {
        const totalEntries = document.getElementById('totalEntries');
        const healthScore = document.getElementById('healthScore');
        const healthFill = document.getElementById('healthFill');
        const riskSummary = document.getElementById('riskSummary');
        const activityList = document.getElementById('activityList');
        const total = passwordEntries.length;
        const passwordMap = passwordEntries.reduce((acc, entry) => { acc[entry.password] = (acc[entry.password] || 0) + 1; return acc; }, {});
        const reused = Object.values(passwordMap).filter(count => count > 1).reduce((a, b) => a + b, 0);
        const weak = passwordEntries.filter(entry => strengthScore(entry.password) <= 1).length;
        const score = total === 0 ? 0 : Math.max(0, Math.round(((total - weak - reused) / total) * 100));
        totalEntries.textContent = total.toString();
        healthScore.textContent = `${score}%`;
        healthFill.style.width = `${score}%`;
        riskSummary.innerHTML = `<i class="fas fa-triangle-exclamation"></i><span>${weak} / ${reused}</span>`;
        activityList.innerHTML = '';
        if (activityLog.length === 0) {
            activityList.innerHTML = `<li class="activity-item"><span>No recent activity</span><span>--</span></li>`;
        } else {
            activityLog.forEach(item => { const li = document.createElement('li'); li.className = 'activity-item'; li.innerHTML = `<span>${item.message}</span><span>${item.time}</span>`; activityList.appendChild(li); });
        }
    };
    const renderPasswords = (f = '') => { pv.passwordList.innerHTML = ''; const filt = passwordEntries.filter(p => p.name.toLowerCase().includes(f.toLowerCase()) || p.username.toLowerCase().includes(f.toLowerCase())); if (filt.length === 0) { pv.passwordList.innerHTML = `<li class="password-item" style="justify-content:center;">${passwordEntries.length === 0 ? 'Vault is empty.' : 'No results.'}</li>`; } filt.forEach(p => { const li = document.createElement('li'); li.className = 'password-item'; li.dataset.id = p.id; li.innerHTML = `<div><h3 style="color: var(--accent-color1);">${p.name}</h3><p style="font-family: monospace; color: #a0a0a0;">User: ${p.username}</p><p class="password-text-display" style="font-family: monospace; color: #a0a0a0;">Pass: ••••••••</p></div><div class="actions" style="display: flex; gap: 0.5rem;"><button class="view-pass-btn" title="Show/Hide"><i class="fas fa-eye"></i></button><button class="copy-pass-btn" title="Copy Pass"><i class="fas fa-copy"></i></button><button class="edit-btn" title="Edit"><i class="fas fa-pencil-alt"></i></button><button class="delete-btn" title="Delete"><i class="fas fa-trash"></i></button></div>`; pv.passwordList.appendChild(li); }); };
    pv.addPasswordBtn.addEventListener('click', () => { pv.passwordForm.reset(); pv.passwordIdInput.value = ''; pv.modalTitle.textContent = 'Add New Entry'; updateStrengthMeter(''); pv.passwordModal.classList.remove('hidden'); });
    pv.passwordModal.querySelector('.close-btn').addEventListener('click', () => pv.passwordModal.classList.add('hidden'));
    pv.passwordForm.addEventListener('submit', (e) => { e.preventDefault(); const entry = { id: pv.passwordIdInput.value || Date.now().toString(), name: document.getElementById('websiteName').value, username: document.getElementById('entryUsername').value, password: document.getElementById('entryPassword').value, updatedAt: new Date().toISOString() }; const idx = passwordEntries.findIndex(p => p.id === entry.id); if (idx > -1) { passwordEntries[idx] = entry; logActivity(`Updated ${entry.name}`); } else { passwordEntries.push(entry); logActivity(`Added ${entry.name}`); } savePasswordsToStorage(); renderPasswords(pv.searchInput.value); updateVaultInsights(); pv.passwordModal.classList.add('hidden'); });
    pv.passwordList.addEventListener('click', (e) => { const btn = e.target.closest('button'); if (!btn) return; const li = btn.closest('.password-item'), id = li.dataset.id, entry = passwordEntries.find(p => p.id === id); if (btn.classList.contains('delete-btn')) { if (confirm(`Delete ${entry.name}?`)) { passwordEntries = passwordEntries.filter(p => p.id !== id); savePasswordsToStorage(); logActivity(`Deleted ${entry.name}`); renderPasswords(pv.searchInput.value); updateVaultInsights(); } } else if (btn.classList.contains('edit-btn')) { pv.modalTitle.textContent = 'Edit Entry'; pv.passwordIdInput.value = entry.id; document.getElementById('websiteName').value = entry.name; document.getElementById('entryUsername').value = entry.username; document.getElementById('entryPassword').value = entry.password; updateStrengthMeter(entry.password); pv.passwordModal.classList.remove('hidden'); } else if (btn.classList.contains('copy-pass-btn')) { navigator.clipboard.writeText(entry.password).then(() => { const i = btn.innerHTML; btn.innerHTML = '<i class="fas fa-check"></i>'; setTimeout(() => { btn.innerHTML = i; }, 1500); }); } else if (btn.classList.contains('view-pass-btn')) { const pEl = li.querySelector('.password-text-display'), icon = btn.querySelector('i'); if (pEl.textContent.includes('•')) { pEl.textContent = `Pass: ${entry.password}`; icon.className = 'fas fa-eye-slash'; } else { pEl.textContent = 'Pass: ••••••••'; icon.className = 'fas fa-eye'; } } });
    pv.searchInput.addEventListener('input', () => renderPasswords(pv.searchInput.value));
    document.getElementById('entryPassword').addEventListener('input', (e) => updateStrengthMeter(e.target.value));
    pv.passwordLength.addEventListener('input', () => { pv.lengthValue.textContent = pv.passwordLength.value; });
    pv.generatePasswordBtn.addEventListener('click', () => {
        const length = parseInt(pv.passwordLength.value, 10);
        const sets = {
            lower: 'abcdefghijklmnopqrstuvwxyz',
            upper: pv.includeUppercase.checked ? 'ABCDEFGHIJKLMNOPQRSTUVWXYZ' : '',
            numbers: pv.includeNumbers.checked ? '0123456789' : '',
            symbols: pv.includeSymbols.checked ? '!@#$%^&*()_+{}[]<>?,.' : ''
        };
        const combined = sets.lower + sets.upper + sets.numbers + sets.symbols;
        if (!combined) return;
        let generated = '';
        const requiredSets = [sets.upper, sets.numbers, sets.symbols].filter(Boolean);
        for (let i = 0; i < length; i += 1) {
            const set = combined;
            generated += set[Math.floor(Math.random() * set.length)];
        }
        requiredSets.forEach(set => { const index = Math.floor(Math.random() * generated.length); generated = `${generated.slice(0, index)}${set[Math.floor(Math.random() * set.length)]}${generated.slice(index + 1)}`; });
        document.getElementById('entryPassword').value = generated;
        updateStrengthMeter(generated);
    });
    const dw = { webhookUrlInput: document.getElementById('webhookUrl'), messageContentInput: document.getElementById('messageContent'), usernameInput: document.getElementById('username'), avatarUrlInput: document.getElementById('avatarUrl'), sendMessageBtn: document.getElementById('sendMessageBtn'), clearFormBtn: document.getElementById('clearFormBtn'), statusMessage: document.getElementById('statusMessage'), spinner: document.getElementById('spinner') };
    if (localStorage.getItem('discordWebhookUrl')) { dw.webhookUrlInput.value = localStorage.getItem('discordWebhookUrl'); }
    const showStatus = (msg, err = false) => { dw.statusMessage.textContent = msg; dw.statusMessage.className = `p-4 rounded-lg text-sm text-center ${err ? 'bg-red-500/20 text-red-300' : 'bg-green-500/20 text-green-300'}`; };
    const setLoading = (load) => { dw.sendMessageBtn.disabled = load; dw.spinner.classList.toggle('hidden', !load); };
    dw.sendMessageBtn.addEventListener('click', async () => { const url = dw.webhookUrlInput.value.trim(), content = dw.messageContentInput.value.trim(); if (!url || !content) { showStatus('Webhook URL and Message are required.', true); return; } localStorage.setItem('discordWebhookUrl', url); const payload = { content, username: dw.usernameInput.value.trim() || undefined, avatar_url: dw.avatarUrlInput.value.trim() || undefined }; setLoading(true); try { const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (res.ok) { showStatus('Message sent successfully!', false); dw.messageContentInput.value = ''; } else { const errData = await res.json(); showStatus(`Failed to send: ${errData.message || 'Unknown error'}`, true); } } catch (error) { showStatus('An error occurred.', true); } finally { setLoading(false); } });
    dw.clearFormBtn.addEventListener('click', () => { dw.messageContentInput.value = ''; dw.usernameInput.value = ''; dw.avatarUrlInput.value = ''; dw.statusMessage.classList.add('hidden'); });
    const init = () => { if (localStorage.getItem(vaultStorageKey)) { showScreen('login'); } else { populateSecurityQuestions(); showScreen('setup'); } updateStrengthMeter(''); updateVaultInsights(); const gapiScript = document.createElement('script'); gapiScript.src = 'https://apis.google.com/js/api.js'; gapiScript.onload = gapiLoaded; document.body.appendChild(gapiScript); const gisScript = document.createElement('script'); gisScript.src = 'https://accounts.google.com/gsi/client'; gisScript.onload = gisLoaded; document.body.appendChild(gisScript); };
    init();
});
</script>

</body>
</html>
